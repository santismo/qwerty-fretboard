<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qwerty Fretboard</title>
    <script src="https://cdn.jsdelivr.net/npm/js-synthesizer@1.11.0/externals/libfluidsynth-2.4.6.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-synthesizer@1.11.0/dist/js-synthesizer.min.js"></script>
    <style>
      :root {
        color-scheme: dark;
        font-family: "Avenir Next", "Futura", "Trebuchet MS", sans-serif;
        color: #f5f5f5;
        --bg: #050505;
        --panel: #0c0c0c;
        --panel-strong: #111111;
        --border: #1f1f1f;
        --text-muted: #9a9a9a;
        --text-soft: #bdbdbd;
        --accent: #ffffff;
        --glow: rgba(255, 255, 255, 0.08);
        --neck-label-width: 64px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        background: radial-gradient(circle at top, #171717, var(--bg) 55%);
      }

      main {
        width: min(1060px, 100%);
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 24px 36px 24px 24px;
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
      }

      header {
        display: grid;
        gap: 16px;
        grid-template-columns: 1fr auto;
        align-items: center;
      }

      h1 {
        margin: 0;
        font-size: 1.6rem;
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      .title-row {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .velocity-pill {
        font-size: 0.8rem;
        color: var(--text-soft);
        border: 1px solid var(--border);
        background: #0b0b0b;
        padding: 4px 10px;
        border-radius: 999px;
        letter-spacing: 0.04em;
      }

      .settings {
        position: relative;
      }

      .settings summary {
        list-style: none;
        width: 38px;
        height: 38px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--panel-strong);
        display: grid;
        place-items: center;
        cursor: pointer;
        font-size: 1.1rem;
      }

      .settings summary::-webkit-details-marker {
        display: none;
      }

      .settings[open] summary {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px var(--glow);
      }

      .settings .controls {
        position: absolute;
        right: 0;
        top: 46px;
        z-index: 5;
      }

      .controls {
        display: grid;
        gap: 10px;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--panel-strong);
        min-width: 280px;
      }

      label {
        font-size: 0.8rem;
        color: var(--text-soft);
      }

      select,
      button,
      input[type="range"] {
        width: 100%;
        background: #0a0a0a;
        border: 1px solid #262626;
        color: var(--accent);
        padding: 8px 10px;
        border-radius: 8px;
        font-size: 0.9rem;
      }

      button {
        cursor: pointer;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
      }

      button:hover {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px var(--glow);
      }

      button[aria-pressed="true"] {
        border-color: var(--accent);
        background: #141414;
      }

      .status {
        font-size: 0.8rem;
        color: #d1d1d1;
      }

      .toggle {
        display: flex;
        gap: 8px;
      }

      .key-map {
        display: grid;
        gap: 4px;
        font-size: 0.72rem;
        color: var(--text-muted);
        line-height: 1.3;
      }

      .key-map span {
        color: var(--text-soft);
        font-weight: 600;
      }

      .fretboard,
      .neck-view {
        margin-top: 20px;
      }

      .string-row {
        display: grid;
        grid-template-columns: 90px 1fr;
        gap: 12px;
        align-items: center;
        padding: 8px 10px;
        border-bottom: 1px solid #141414;
      }

      .string-row:last-child {
        border-bottom: none;
      }

      .string-label {
        font-size: 0.85rem;
        color: #d6d6d6;
      }

      .frets {
        display: grid;
        grid-auto-flow: column;
        grid-auto-columns: minmax(38px, 1fr);
        gap: 8px;
        transition: transform 0.15s ease;
      }

      .fret {
        background: #0f0f0f;
        border-radius: 6px;
        padding: 6px 4px;
        text-align: center;
        border: 1px solid #1a1a1a;
        font-size: 0.75rem;
        color: var(--text-soft);
        display: grid;
        gap: 2px;
        min-height: 44px;
      }

      .fret span {
        font-size: 0.65rem;
        color: #7a7a7a;
      }

      .fret.active {
        border-color: #ffffff;
        color: #ffffff;
        background: #1a1a1a;
      }

      .classic-markers {
        margin-top: 8px;
        display: grid;
        grid-template-columns: 90px 1fr;
        gap: 12px;
        align-items: center;
      }

      .classic-markers-row {
        display: grid;
        grid-template-columns: repeat(var(--fret-count), 1fr);
        gap: 8px;
        height: 10px;
        transition: transform 0.15s ease;
      }

      .classic-markers-row span {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: #262626;
        opacity: 0;
        justify-self: center;
      }

      .classic-markers-row span.marker-dot {
        opacity: 1;
      }

      .classic-markers-row.slanted {
        transform: translateX(var(--row-offset, 0px));
      }

      .hidden {
        display: none;
      }

      .neck-wrap {
        position: relative;
        padding: 20px 10px 10px 10px;
        background: #0d0d0d;
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
      }

      .neck {
        display: grid;
        gap: 10px;
      }

      .neck-row,
      .edge-row {
        display: grid;
        grid-template-columns: var(--neck-label-width) 1fr;
        gap: 8px;
        align-items: center;
      }

      .neck-label {
        font-size: 0.75rem;
        color: var(--text-soft);
        text-align: right;
        padding-right: 6px;
      }

      .neck-label.spacer {
        opacity: 0;
      }

      .neck-string {
        display: grid;
        grid-template-columns: repeat(var(--fret-count), 1fr);
        gap: 6px;
        align-items: center;
        margin-left: var(--row-offset, 0px);
      }

      .neck-fret {
        position: relative;
        height: 30px;
        border-left: 1px solid #1f1f1f;
        border-right: 1px solid #1f1f1f;
        background: #0a0a0a;
      }

      .neck-fret.open {
        border-left: 3px solid #2a2a2a;
        background: #0c0c0c;
      }

      .neck-fret.marker::after {
        content: "";
        position: absolute;
        inset: 8px 40%;
        border-radius: 999px;
        background: #1f1f1f;
      }

      .note-dot {
        position: absolute;
        inset: 4px;
        border-radius: 999px;
        background: #ffffff;
        color: #050505;
        font-size: 0.6rem;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.1s ease;
      }

      .neck-fret.active .note-dot {
        opacity: 1;
      }

      .edge-row {
        margin-top: 6px;
      }

      .edge-labels {
        display: grid;
        grid-template-columns: repeat(var(--fret-count), 1fr);
        gap: 6px;
        height: 12px;
        font-size: 0.75rem;
        color: var(--text-muted);
        text-align: center;
        letter-spacing: 0.08em;
        transform: translateX(var(--edge-offset, 0px));
      }

      .edge-labels div {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .fretboard.slanted .string-row .frets {
        transform: translateX(var(--row-offset, 0px));
      }

      .range-row {
        display: grid;
        gap: 6px;
      }

      .range-row span {
        font-size: 0.75rem;
        color: #bdbdbd;
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <div>
          <div class="title-row">
            <h1>Qwerty Fretboard</h1>
            <div class="velocity-pill" id="velocity-display">Vel 100</div>
          </div>
        </div>
        <details class="settings" id="settings">
          <summary aria-label="Settings">⚙️</summary>
          <div class="controls">
            <div>
              <label for="midi-output">Output</label>
              <select id="midi-output"></select>
            </div>
            <button id="refresh-midi" type="button">Refresh</button>
            <div class="range-row">
              <label for="vibrato-rate">Vibrato</label>
              <input id="vibrato-rate" type="range" min="2" max="12" value="6" step="1" />
              <span id="vibrato-value">6 Hz</span>
            </div>
            <div class="range-row">
              <label for="bend-range">Bend range</label>
              <input id="bend-range" type="range" min="1" max="12" value="2" step="1" />
              <span id="bend-value">2 st</span>
            </div>
            <div class="toggle">
              <button id="mode-classic" type="button" aria-pressed="true">Classic</button>
              <button id="mode-neck" type="button" aria-pressed="false">Neck</button>
            </div>
            <button id="toggle-slant" type="button" aria-pressed="false">Slant</button>
            <div class="toggle">
              <button id="soundfont-toggle" type="button" aria-pressed="false">SoundFont</button>
            </div>
            <div>
              <label for="soundfont-program">Sound</label>
              <select id="soundfont-program"></select>
            </div>
            <div class="status" id="soundfont-status">Soundfont: off.</div>
            <div class="status" id="midi-status">MIDI: not connected.</div>
            <div class="key-map">
              <div><span>1:</span> 1 2 3 4 5 6 7 8 9 0 -</div>
              <div><span>Q:</span> Q W E R T Y U I O P [</div>
              <div><span>A:</span> A S D F G H J K L ; '</div>
              <div><span>Z:</span> Z X C V B N M , . / Shift</div>
              <div>
                <span>Other:</span> Caps = high strings, Arrows = bend/transpose, Space = vibrato,
                ` / Tab = velocity
              </div>
            </div>
          </div>
        </details>
      </header>

      <section class="fretboard" id="fretboard"></section>
      <div class="classic-markers" id="classic-markers">
        <div class="string-label"></div>
        <div class="classic-markers-row" id="classic-markers-row"></div>
      </div>

      <section class="neck-view hidden" id="neck-view">
        <div class="neck-wrap">
          <div class="neck" id="neck"></div>
          <div class="edge-row">
            <div class="neck-label spacer"></div>
            <div class="edge-labels" id="edge-labels"></div>
          </div>
        </div>
      </section>
    </main>

    <script>
      const rowDefinitions = [
        {
          id: "row-1",
          displayName: "1 row",
          keys: [
            { code: "Digit1", label: "1" },
            { code: "Digit2", label: "2" },
            { code: "Digit3", label: "3" },
            { code: "Digit4", label: "4" },
            { code: "Digit5", label: "5" },
            { code: "Digit6", label: "6" },
            { code: "Digit7", label: "7" },
            { code: "Digit8", label: "8" },
            { code: "Digit9", label: "9" },
            { code: "Digit0", label: "0" },
            { code: "Minus", label: "-" },
          ],
        },
        {
          id: "row-q",
          displayName: "Q row",
          keys: [
            { code: "KeyQ", label: "Q" },
            { code: "KeyW", label: "W" },
            { code: "KeyE", label: "E" },
            { code: "KeyR", label: "R" },
            { code: "KeyT", label: "T" },
            { code: "KeyY", label: "Y" },
            { code: "KeyU", label: "U" },
            { code: "KeyI", label: "I" },
            { code: "KeyO", label: "O" },
            { code: "KeyP", label: "P" },
            { code: "BracketLeft", label: "[" },
          ],
        },
        {
          id: "row-a",
          displayName: "A row",
          keys: [
            { code: "KeyA", label: "A" },
            { code: "KeyS", label: "S" },
            { code: "KeyD", label: "D" },
            { code: "KeyF", label: "F" },
            { code: "KeyG", label: "G" },
            { code: "KeyH", label: "H" },
            { code: "KeyJ", label: "J" },
            { code: "KeyK", label: "K" },
            { code: "KeyL", label: "L" },
            { code: "Semicolon", label: ";" },
            { code: "Quote", label: "'" },
          ],
        },
        {
          id: "row-z",
          displayName: "Z row",
          keys: [
            { code: "KeyZ", label: "Z" },
            { code: "KeyX", label: "X" },
            { code: "KeyC", label: "C" },
            { code: "KeyV", label: "V" },
            { code: "KeyB", label: "B" },
            { code: "KeyN", label: "N" },
            { code: "KeyM", label: "M" },
            { code: "Comma", label: "," },
            { code: "Period", label: "." },
            { code: "Slash", label: "/" },
            { code: "ShiftRight", label: "Shift" },
          ],
        },
      ];

      const tuningNormal = [
        { name: "G", base: 55 },
        { name: "D", base: 50 },
        { name: "A", base: 45 },
        { name: "E", base: 40 },
      ];

      const tuningCaps = [
        { name: "e", base: 64 },
        { name: "B", base: 59 },
        { name: "G", base: 55 },
        { name: "D", base: 50 },
      ];

      const DEFAULT_SOUNDFONT_URL =
        "https://github.com/santismo/qwerty-fretboard/blob/main/Roland.SC-55.sf2";

      const gmPrograms = [
        "Acoustic Grand Piano",
        "Bright Acoustic Piano",
        "Electric Grand Piano",
        "Honky-tonk Piano",
        "Electric Piano 1",
        "Electric Piano 2",
        "Harpsichord",
        "Clavinet",
        "Celesta",
        "Glockenspiel",
        "Music Box",
        "Vibraphone",
        "Marimba",
        "Xylophone",
        "Tubular Bells",
        "Dulcimer",
        "Drawbar Organ",
        "Percussive Organ",
        "Rock Organ",
        "Church Organ",
        "Reed Organ",
        "Accordion",
        "Harmonica",
        "Tango Accordion",
        "Acoustic Guitar (nylon)",
        "Acoustic Guitar (steel)",
        "Electric Guitar (jazz)",
        "Electric Guitar (clean)",
        "Electric Guitar (muted)",
        "Overdriven Guitar",
        "Distortion Guitar",
        "Guitar Harmonics",
        "Acoustic Bass",
        "Electric Bass (finger)",
        "Electric Bass (pick)",
        "Fretless Bass",
        "Slap Bass 1",
        "Slap Bass 2",
        "Synth Bass 1",
        "Synth Bass 2",
        "Violin",
        "Viola",
        "Cello",
        "Contrabass",
        "Tremolo Strings",
        "Pizzicato Strings",
        "Orchestral Harp",
        "Timpani",
        "String Ensemble 1",
        "String Ensemble 2",
        "Synth Strings 1",
        "Synth Strings 2",
        "Choir Aahs",
        "Voice Oohs",
        "Synth Voice",
        "Orchestra Hit",
        "Trumpet",
        "Trombone",
        "Tuba",
        "Muted Trumpet",
        "French Horn",
        "Brass Section",
        "Synth Brass 1",
        "Synth Brass 2",
        "Soprano Sax",
        "Alto Sax",
        "Tenor Sax",
        "Baritone Sax",
        "Oboe",
        "English Horn",
        "Bassoon",
        "Clarinet",
        "Piccolo",
        "Flute",
        "Recorder",
        "Pan Flute",
        "Blown Bottle",
        "Shakuhachi",
        "Whistle",
        "Ocarina",
        "Lead 1 (square)",
        "Lead 2 (sawtooth)",
        "Lead 3 (calliope)",
        "Lead 4 (chiff)",
        "Lead 5 (charang)",
        "Lead 6 (voice)",
        "Lead 7 (fifths)",
        "Lead 8 (bass + lead)",
        "Pad 1 (new age)",
        "Pad 2 (warm)",
        "Pad 3 (polysynth)",
        "Pad 4 (choir)",
        "Pad 5 (bowed)",
        "Pad 6 (metallic)",
        "Pad 7 (halo)",
        "Pad 8 (sweep)",
        "FX 1 (rain)",
        "FX 2 (soundtrack)",
        "FX 3 (crystal)",
        "FX 4 (atmosphere)",
        "FX 5 (brightness)",
        "FX 6 (goblins)",
        "FX 7 (echoes)",
        "FX 8 (sci-fi)",
        "Sitar",
        "Banjo",
        "Shamisen",
        "Koto",
        "Kalimba",
        "Bag pipe",
        "Fiddle",
        "Shanai",
        "Tinkle Bell",
        "Agogo",
        "Steel Drums",
        "Woodblock",
        "Taiko Drum",
        "Melodic Tom",
        "Synth Drum",
        "Reverse Cymbal",
        "Guitar Fret Noise",
        "Breath Noise",
        "Seashore",
        "Bird Tweet",
        "Telephone Ring",
        "Helicopter",
        "Applause",
        "Gunshot",
      ];

      const midiOutputSelect = document.getElementById("midi-output");
      const midiStatus = document.getElementById("midi-status");
      const refreshButton = document.getElementById("refresh-midi");
      const fretboard = document.getElementById("fretboard");
      const classicMarkers = document.getElementById("classic-markers");
      const classicMarkersRow = document.getElementById("classic-markers-row");
      const neckView = document.getElementById("neck-view");
      const neck = document.getElementById("neck");
      const edgeLabels = document.getElementById("edge-labels");
      const modeClassic = document.getElementById("mode-classic");
      const modeNeck = document.getElementById("mode-neck");
      const toggleSlant = document.getElementById("toggle-slant");
      const soundFontToggle = document.getElementById("soundfont-toggle");
      const soundFontProgram = document.getElementById("soundfont-program");
      const soundFontStatus = document.getElementById("soundfont-status");
      const bendRange = document.getElementById("bend-range");
      const bendValue = document.getElementById("bend-value");
      const vibratoRate = document.getElementById("vibrato-rate");
      const vibratoValue = document.getElementById("vibrato-value");
      const velocityDisplay = document.getElementById("velocity-display");

      let midiAccess = null;
      let midiOutput = null;
      let capsLockOn = false;
      let octaveTranspose = 0;
      let pitchMode = "center";
      let vibratoActive = false;
      let vibratoTimer = null;
      let vibratoPhase = 0;
      let bendSemitones = Number(bendRange.value);
      let noteVelocity = 100;
      let soundFontEnabled = false;
      const activeNotes = new Map();

      let audioCtx = null;
      let master = null;

      const sf = {
        synth: null,
        node: null,
        sfontId: null,
        ready: false,
        loadingSynth: false,
        loadingFont: false,
        lastUrl: "",
        program: 0,
      };

      const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
      const cellsByCode = new Map();
      const neckCells = new Map();
      const neckCellsByCode = new Map();
      const neckLabelEls = [];
      const rowOffsetStep = 14;
      const velocityStep = 5;
      const markerFrets = [3, 5, 7, 9];
      const markerSymbols = ["V", "N", "<", "?"];
      const markerFretSet = new Set(markerFrets);
      const markerLabelMap = new Map(markerFrets.map((fret, index) => [fret, markerSymbols[index]]));

      function getNoteName(midiNote) {
        const octave = Math.floor(midiNote / 12) - 1;
        const name = noteNames[midiNote % 12];
        return `${name}${octave}`;
      }

      function updateVelocityDisplay() {
        velocityDisplay.textContent = `Vel ${noteVelocity}`;
      }

      function populateSoundFontPrograms() {
        soundFontProgram.innerHTML = "";
        gmPrograms.forEach((name, index) => {
          const option = document.createElement("option");
          option.value = index;
          option.textContent = `${index + 1}. ${name}`;
          soundFontProgram.appendChild(option);
        });
        soundFontProgram.value = "0";
        soundFontProgram.disabled = true;
      }

      function normalizeSoundFontUrl(url) {
        let u = String(url || "").trim();
        if (!u) return "";
        const match = u.match(/^https?:\/\/github\.com\/([^/]+)\/([^/]+)\/blob\/([^#?]+)/i);
        if (match) {
          u = `https://raw.githubusercontent.com/${match[1]}/${match[2]}/${match[3]}`;
        }
        return u;
      }

      function ensureAudioContext() {
        if (audioCtx) return audioCtx;
        const AC = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AC({ latencyHint: "interactive" });
        master = audioCtx.createGain();
        master.gain.value = 0.9;
        master.connect(audioCtx.destination);
        return audioCtx;
      }

      function updateSoundFontStatus(text) {
        soundFontStatus.textContent = text;
      }

      async function ensureSoundFontSynth() {
        if (sf.synth || sf.loadingSynth) return;
        sf.loadingSynth = true;
        try {
          if (!window.JSSynth) throw new Error("Soundfont engine unavailable.");
          await window.JSSynth.waitForReady();
          const ctx = ensureAudioContext();
          const synth = new window.JSSynth.Synthesizer();
          synth.init(ctx.sampleRate, { initialGain: 0.7, midiChannelCount: 16 });
          const node = synth.createAudioNode(ctx, 4096);
          node.connect(master);
          sf.synth = synth;
          sf.node = node;
        } finally {
          sf.loadingSynth = false;
        }
      }

      async function loadSoundFontUrl(url) {
        if (sf.loadingFont) return;
        sf.loadingFont = true;
        try {
          await ensureSoundFontSynth();
          const normalized = normalizeSoundFontUrl(url);
          if (!normalized) throw new Error("Soundfont URL missing.");
          const res = await fetch(normalized, { cache: "no-store" });
          if (!res.ok) throw new Error("Soundfont fetch failed.");
          const buffer = await res.arrayBuffer();
          if (sf.sfontId != null) {
            try {
              sf.synth.unloadSFont(sf.sfontId);
            } catch {}
          }
          sf.sfontId = await sf.synth.loadSFont(buffer);
          sf.ready = true;
          sf.lastUrl = normalized;
          applySoundFontProgram(sf.program);
        } finally {
          sf.loadingFont = false;
        }
      }

      function applySoundFontProgram(program) {
        if (!sf.ready || !sf.synth || sf.sfontId == null) return;
        const prog = Math.max(0, Math.min(127, Math.round(program)));
        sf.program = prog;
        sf.synth.midiProgramSelect(0, sf.sfontId, 0, prog);
      }

      function sendSoundFontControlChange(controller, value) {
        if (!soundFontEnabled || !sf.synth) return;
        if (typeof sf.synth.midiControlChange === "function") {
          sf.synth.midiControlChange(0, controller, value);
        }
      }

      function sendSoundFontPitchBend(value) {
        if (!soundFontEnabled || !sf.synth) return;
        if (typeof sf.synth.midiPitchBend === "function") {
          sf.synth.midiPitchBend(0, value);
        } else if (typeof sf.synth.midiPitchWheel === "function") {
          sf.synth.midiPitchWheel(0, value);
        }
      }

      function sendPitchBendSensitivity(semitones) {
        const value = Math.max(1, Math.min(12, Math.round(semitones)));
        const messages = [
          [0xb0, 101, 0],
          [0xb0, 100, 0],
          [0xb0, 6, value],
          [0xb0, 38, 0],
          [0xb0, 101, 127],
          [0xb0, 100, 127],
        ];
        messages.forEach(sendMidi);
        sendSoundFontControlChange(101, 0);
        sendSoundFontControlChange(100, 0);
        sendSoundFontControlChange(6, value);
        sendSoundFontControlChange(38, 0);
        sendSoundFontControlChange(101, 127);
        sendSoundFontControlChange(100, 127);
      }

      async function setSoundFontEnabled(enabled) {
        if (soundFontEnabled === enabled) return;
        soundFontEnabled = enabled;
        soundFontToggle.setAttribute("aria-pressed", String(enabled));
        soundFontProgram.disabled = !enabled;
        if (!enabled) {
          updateSoundFontStatus("Soundfont: off.");
          soundFontAllNotesOff();
          return;
        }
        const ctx = ensureAudioContext();
        if (ctx.state === "suspended") {
          await ctx.resume();
        }
        const normalized = normalizeSoundFontUrl(DEFAULT_SOUNDFONT_URL);
        if (sf.ready && sf.lastUrl === normalized) {
          updateSoundFontStatus("Soundfont: ready.");
          sendPitchBendSensitivity(bendSemitones);
          return;
        }
        updateSoundFontStatus("Soundfont: loading...");
        try {
          await loadSoundFontUrl(DEFAULT_SOUNDFONT_URL);
          updateSoundFontStatus("Soundfont: ready.");
          sendPitchBendSensitivity(bendSemitones);
        } catch {
          updateSoundFontStatus("Soundfont: failed.");
          soundFontEnabled = false;
          soundFontToggle.setAttribute("aria-pressed", "false");
          soundFontProgram.disabled = true;
        }
      }

      function soundFontNoteOn(midiNote, velocity) {
        if (!soundFontEnabled || !sf.ready || !sf.synth) return;
        const v = Math.max(1, Math.min(127, Math.round(velocity)));
        sf.synth.midiNoteOn(0, midiNote, v);
      }

      function soundFontNoteOff(midiNote) {
        if (!soundFontEnabled || !sf.ready || !sf.synth) return;
        sf.synth.midiNoteOff(0, midiNote);
      }

      function soundFontAllNotesOff() {
        if (!sf.synth) return;
        try {
          sf.synth.midiAllNotesOff(0);
        } catch {}
      }

      function renderFretboard() {
        fretboard.innerHTML = "";
        cellsByCode.clear();

        rowDefinitions.forEach((row, rowIndex) => {
          const rowEl = document.createElement("div");
          rowEl.className = "string-row";
          rowEl.style.setProperty("--row-offset", `${rowIndex * rowOffsetStep}px`);

          const labelEl = document.createElement("div");
          labelEl.className = "string-label";
          labelEl.textContent = row.displayName;
          rowEl.appendChild(labelEl);

          const fretsEl = document.createElement("div");
          fretsEl.className = "frets";

          row.keys.forEach((key, index) => {
            const fretEl = document.createElement("div");
            fretEl.className = "fret";
            fretEl.dataset.code = key.code;
            fretEl.dataset.fret = index;
            fretEl.innerHTML = `<div>${key.label}</div><span></span>`;
            fretsEl.appendChild(fretEl);
            cellsByCode.set(key.code, fretEl);
          });

          rowEl.appendChild(fretsEl);
          fretboard.appendChild(rowEl);
        });

        const fretCount = rowDefinitions[0].keys.length;
        const bottomOffset = (rowDefinitions.length - 1) * rowOffsetStep;
        classicMarkersRow.innerHTML = "";
        classicMarkersRow.style.setProperty("--fret-count", fretCount);
        classicMarkersRow.style.setProperty("--row-offset", `${bottomOffset}px`);

        for (let fretIndex = 0; fretIndex < fretCount; fretIndex += 1) {
          const marker = document.createElement("span");
          if (markerFretSet.has(fretIndex)) {
            marker.classList.add("marker-dot");
          }
          classicMarkersRow.appendChild(marker);
        }
      }

      function renderNeckView() {
        neck.innerHTML = "";
        edgeLabels.innerHTML = "";
        neckCells.clear();
        neckCellsByCode.clear();
        neckLabelEls.length = 0;

        const fretCount = rowDefinitions[0].keys.length;
        const bottomOffset = (rowDefinitions.length - 1) * rowOffsetStep;
        const markerFretsSet = new Set(markerFrets);
        neck.style.setProperty("--fret-count", fretCount);
        edgeLabels.style.setProperty("--fret-count", fretCount);
        edgeLabels.style.setProperty("--edge-offset", `${bottomOffset}px`);

        rowDefinitions.forEach((row, rowIndex) => {
          const rowWrap = document.createElement("div");
          rowWrap.className = "neck-row";

          const labelEl = document.createElement("div");
          labelEl.className = "neck-label";
          rowWrap.appendChild(labelEl);
          neckLabelEls[rowIndex] = labelEl;

          const stringRow = document.createElement("div");
          stringRow.className = "neck-string";
          stringRow.style.setProperty("--row-offset", `${rowIndex * rowOffsetStep}px`);

          for (let fretIndex = 0; fretIndex < fretCount; fretIndex += 1) {
            const fretEl = document.createElement("div");
            fretEl.className = "neck-fret";
            fretEl.dataset.fret = fretIndex;
            if (fretIndex === 0) {
              fretEl.classList.add("open");
            }
            if (markerFretsSet.has(fretIndex)) {
              fretEl.classList.add("marker");
            }
            const noteDot = document.createElement("div");
            noteDot.className = "note-dot";
            fretEl.appendChild(noteDot);
            stringRow.appendChild(fretEl);
            neckCells.set(`${rowIndex}-${fretIndex}`, { fretEl, noteDot });

            const key = row.keys[fretIndex];
            if (key) {
              neckCellsByCode.set(key.code, fretEl);
            }
          }
          rowWrap.appendChild(stringRow);
          neck.appendChild(rowWrap);
        });

        for (let fretIndex = 0; fretIndex < fretCount; fretIndex += 1) {
          const marker = document.createElement("div");
          const markerLabel = markerLabelMap.get(fretIndex);
          if (markerLabel) {
            marker.textContent = markerLabel;
          }
          edgeLabels.appendChild(marker);
        }
      }

      function updateTuningDisplay() {
        const tuning = capsLockOn ? tuningCaps : tuningNormal;
        const rows = fretboard.querySelectorAll(".string-row");
        const transposeLabel =
          octaveTranspose === 0 ? "" : ` ${octaveTranspose >= 0 ? "+" : ""}${octaveTranspose}`;

        rows.forEach((rowEl, rowIndex) => {
          const labelEl = rowEl.querySelector(".string-label");
          const frets = rowEl.querySelectorAll(".fret");
          const stringInfo = tuning[rowIndex];
          labelEl.textContent = `${stringInfo.name}${transposeLabel}`;

          frets.forEach((fretEl) => {
            const fretNumber = Number(fretEl.dataset.fret);
            const midiNote = stringInfo.base + fretNumber + octaveTranspose * 12;
            fretEl.dataset.note = midiNote;
            const noteSpan = fretEl.querySelector("span");
            noteSpan.textContent = getNoteName(midiNote);
          });
        });

        neckLabelEls.forEach((labelEl, rowIndex) => {
          const stringInfo = tuning[rowIndex];
          labelEl.textContent = `${stringInfo.name}${transposeLabel}`;
        });

        updateNeckNotes();
      }

      function updateNeckNotes() {
        const tuning = capsLockOn ? tuningCaps : tuningNormal;
        const fretCount = rowDefinitions[0].keys.length;

        for (let stringIndex = 0; stringIndex < tuning.length; stringIndex += 1) {
          for (let fretIndex = 0; fretIndex < fretCount; fretIndex += 1) {
            const midiNote = tuning[stringIndex].base + fretIndex + octaveTranspose * 12;
            const cell = neckCells.get(`${stringIndex}-${fretIndex}`);
            if (!cell) continue;
            cell.fretEl.dataset.note = midiNote;
            cell.noteDot.textContent = getNoteName(midiNote);
          }
        }
      }

      function setCapsLockState(nextState) {
        if (capsLockOn !== nextState) {
          capsLockOn = nextState;
          updateTuningDisplay();
        }
      }

      function sendMidi(message) {
        if (midiOutput) {
          midiOutput.send(message);
        }
      }

      function sendPitchBend(value) {
        const clamped = Math.min(16383, Math.max(0, value));
        const lsb = clamped & 0x7f;
        const msb = (clamped >> 7) & 0x7f;
        sendMidi([0xe0, lsb, msb]);
        sendSoundFontPitchBend(clamped);
      }

      function stopVibrato() {
        if (vibratoTimer) {
          clearInterval(vibratoTimer);
          vibratoTimer = null;
        }
        vibratoPhase = 0;
        if (pitchMode === "center") {
          sendPitchBend(8192);
        }
      }

      function startVibrato() {
        if (vibratoTimer) return;
        const rate = Number(vibratoRate.value);
        const baseDepth = 2200;
        const depth = Math.round(baseDepth * (2 / Math.max(1, bendSemitones)));
        vibratoTimer = setInterval(() => {
          if (pitchMode !== "center") return;
          vibratoPhase += (rate / 60) * Math.PI * 2;
          const bendAmount = Math.round(Math.sin(vibratoPhase) * depth);
          sendPitchBend(8192 + bendAmount);
        }, 16);
      }

      function updateBendRange() {
        bendSemitones = Number(bendRange.value);
        bendValue.textContent = `${bendSemitones} st`;
        sendPitchBendSensitivity(bendSemitones);
        if (pitchMode === "left") {
          sendPitchBend(0);
        } else if (pitchMode === "right") {
          sendPitchBend(16383);
        }
        if (vibratoActive && pitchMode === "center") {
          stopVibrato();
          startVibrato();
        }
      }

      function handleKeyDown(event) {
        setCapsLockState(event.getModifierState("CapsLock"));

        if (["ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown", "Space", "Tab"].includes(event.code)) {
          event.preventDefault();
        }

        if (event.code === "ArrowLeft" && pitchMode !== "left") {
          pitchMode = "left";
          stopVibrato();
          sendPitchBend(0);
          return;
        }

        if (event.code === "ArrowRight" && pitchMode !== "right") {
          pitchMode = "right";
          stopVibrato();
          sendPitchBend(16383);
          return;
        }

        if (event.code === "ArrowUp" && !event.repeat) {
          octaveTranspose += 1;
          updateTuningDisplay();
          return;
        }

        if (event.code === "ArrowDown" && !event.repeat) {
          octaveTranspose -= 1;
          updateTuningDisplay();
          return;
        }

        if (event.code === "Space") {
          vibratoActive = true;
          if (pitchMode === "center") {
            startVibrato();
          }
          return;
        }

        if (event.code === "Backquote") {
          noteVelocity = Math.min(127, noteVelocity + velocityStep);
          updateVelocityDisplay();
          return;
        }

        if (event.code === "Tab") {
          noteVelocity = Math.max(1, noteVelocity - velocityStep);
          updateVelocityDisplay();
          return;
        }

        const cell = cellsByCode.get(event.code);
        if (!cell || event.repeat) return;

        const midiNote = Number(cell.dataset.note);
        activeNotes.set(event.code, midiNote);
        cell.classList.add("active");
        const neckCell = neckCellsByCode.get(event.code);
        if (neckCell) {
          neckCell.classList.add("active");
        }
        sendMidi([0x90, midiNote, noteVelocity]);
        soundFontNoteOn(midiNote, noteVelocity);
      }

      function handleKeyUp(event) {
        setCapsLockState(event.getModifierState("CapsLock"));

        if (event.code === "ArrowLeft" && pitchMode === "left") {
          pitchMode = "center";
          if (vibratoActive) {
            startVibrato();
          } else {
            sendPitchBend(8192);
          }
          return;
        }

        if (event.code === "ArrowRight" && pitchMode === "right") {
          pitchMode = "center";
          if (vibratoActive) {
            startVibrato();
          } else {
            sendPitchBend(8192);
          }
          return;
        }

        if (event.code === "Space") {
          vibratoActive = false;
          stopVibrato();
          return;
        }

        const midiNote = activeNotes.get(event.code);
        if (midiNote === undefined) return;
        activeNotes.delete(event.code);
        const cell = cellsByCode.get(event.code);
        if (cell) {
          cell.classList.remove("active");
        }
        const neckCell = neckCellsByCode.get(event.code);
        if (neckCell) {
          neckCell.classList.remove("active");
        }
        sendMidi([0x80, midiNote, 0x00]);
        soundFontNoteOff(midiNote);
      }

      function refreshMidiOutputs() {
        midiOutputSelect.innerHTML = "";
        if (!midiAccess) {
          midiStatus.textContent = "MIDI: not supported.";
          return;
        }

        const outputs = Array.from(midiAccess.outputs.values());
        if (!outputs.length) {
          midiStatus.textContent = "MIDI: no outputs.";
          return;
        }

        outputs.forEach((output, index) => {
          const option = document.createElement("option");
          option.value = output.id;
          option.textContent = output.name || `Output ${index + 1}`;
          midiOutputSelect.appendChild(option);
        });

        midiOutputSelect.selectedIndex = 0;
        midiOutput = outputs[0];
        midiStatus.textContent = `MIDI: ${midiOutput.name || "connected"}.`;
        sendPitchBendSensitivity(bendSemitones);
      }

      async function initMidi() {
        if (!navigator.requestMIDIAccess) {
          midiStatus.textContent = "MIDI: unavailable.";
          return;
        }

        try {
          midiAccess = await navigator.requestMIDIAccess();
          midiStatus.textContent = "MIDI: ready.";
          refreshMidiOutputs();
        } catch (error) {
          midiStatus.textContent = "MIDI: blocked.";
        }
      }

      midiOutputSelect.addEventListener("change", (event) => {
        const outputId = event.target.value;
        midiOutput = midiAccess?.outputs.get(outputId) || null;
        midiStatus.textContent = midiOutput
          ? `MIDI: ${midiOutput.name || "connected"}.`
          : "MIDI: choose output.";
        sendPitchBendSensitivity(bendSemitones);
      });

      refreshButton.addEventListener("click", () => {
        refreshMidiOutputs();
      });

      function setView(view) {
        const showClassic = view === "classic";
        fretboard.classList.toggle("hidden", !showClassic);
        classicMarkers.classList.toggle("hidden", !showClassic);
        neckView.classList.toggle("hidden", showClassic);
        modeClassic.setAttribute("aria-pressed", String(showClassic));
        modeNeck.setAttribute("aria-pressed", String(!showClassic));
      }

      modeClassic.addEventListener("click", () => {
        setView("classic");
      });

      modeNeck.addEventListener("click", () => {
        setView("neck");
      });

      toggleSlant.addEventListener("click", () => {
        const isActive = fretboard.classList.toggle("slanted");
        classicMarkersRow.classList.toggle("slanted", isActive);
        toggleSlant.setAttribute("aria-pressed", String(isActive));
      });

      soundFontToggle.addEventListener("click", () => {
        setSoundFontEnabled(!soundFontEnabled);
      });

      soundFontProgram.addEventListener("change", () => {
        const program = Number(soundFontProgram.value);
        applySoundFontProgram(program);
      });

      bendRange.addEventListener("input", () => {
        updateBendRange();
      });

      vibratoRate.addEventListener("input", () => {
        vibratoValue.textContent = `${vibratoRate.value} Hz`;
        if (vibratoActive && pitchMode === "center") {
          stopVibrato();
          startVibrato();
        }
      });

      window.addEventListener("keydown", handleKeyDown);
      window.addEventListener("keyup", handleKeyUp);

      populateSoundFontPrograms();
      renderFretboard();
      renderNeckView();
      updateTuningDisplay();
      updateVelocityDisplay();
      updateBendRange();
      setView("classic");
      initMidi();
    </script>
  </body>
</html>
